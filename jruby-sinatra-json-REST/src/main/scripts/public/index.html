<!doctype html>
<html lang="en" ng-app>
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8">
	<title>index</title>
	<link rel="stylesheet" href="http://twitter.github.com/bootstrap/1.4.0/bootstrap.min.css">
	<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.0.3/angular.min.js"></script>
	<script>
	
	function StockPortfolioCtrl($scope, $http){
	
		// Get
		$http.get('/stocks', { "data" : ""}).
		        success(function(data, status) {$scope.status = status; $scope.stocks = data;}).
				error(  function(data, status) {$scope.status = status;});
	    
		// Delete
		$scope.deleteStock =  function(t, index){
		
			if (confirm('Delete '+t+'?')){
				// Delete the record from the local collection
				$scope.stocks.splice(index, 1);
				
				// REST call to delete the record
				$http.delete('/stock/' + t, { "data" : t}).
		        	success(function(data, status) {$scope.status = status;}).
					error(  function(data, status) {$scope.status = status;});
			}
		}
		
		// JSONP Call to Google to lookup company information
		$scope.getStockData = function(){
			
			if ($scope.t.length > 0)
			{
			var url = 'http://www.google.com/finance/info?callback=JSON_CALLBACK&infotype=infoquoteall&q=' + 
						$scope.t ;
			$http.jsonp(url ,{isArray: true}).
			    success(function(data, status, headers, config) {
					window.myData = data;
					$scope.name = data[0].name;
					$scope.l_cur = data[0].l_cur;
			    }).
			    error(function(data, status, headers, config) {
				    // Ignore invalid requests
					//alert("status:"+status + " headers:" + headers +' data '+ data)
			    });

			}	
		}
		
		// Add
		$scope.showAddForm = function() {
	        $scope.addFormIsVisible = true; 
	    };

	 	$scope.hideAddForm = function() {
	        $scope.t = '';
	        $scope.name = '';
			$scope.l_cur = '';

	        $scope.addFormIsVisible = false; 	        
	    };

		$scope.saveStock = function() {
			    var rec = {
		        "created_at": new Date(),
		        "t": $scope.t,
		        "name": $scope.name,
		        "l_cur": $scope.l_cur}
		
		        $scope.stocks.push(rec);

				 $http.put('/stock/' + $scope.t, {"data" : rec}).
		        	success(function(data, status) {$scope.status = status;}).
					error(  function(data, status) {alert(data);$scope.status = status;});

		         $scope.hideAddForm();
		    };

		// Order
	    $scope.orderProp = 't';	
	    $scope.orderBy = function(col) {$scope.orderProp = col;}	
	
	}
	</script>	
	<!--
	http://d.yimg.com/autoc.finance.yahoo.com/autoc?query=AAPL&callback=YAHOO.Finance.SymbolSuggest.ssCallback
	http://www.google.com/finance/info?infotype=infoquoteall&q=AAPL
	-->
</head>
<body>
	
	<div class="container" ng-app ng-controller="StockPortfolioCtrl">

	<div class="row">
		<div class="row">
		    <div class="span10" align="center"><h2>Stock Portfolio</h2>
			</div>
		</div>
		
	    <div class="span10">
	    Filter: <input ng-model="query" class='small'>

	    <br/><br/>

	<table class="table-condensed table-hover zebra-striped bordered-table">
		<thead>
			<tr>
	        	<th ng-click="orderBy('t')">Symbol</th>
	        	<th ng-click="orderBy('name')">Description</th>
	        	<th ng-click="orderBy('l_cur')">Price</th>
				<th>
					<a ng-click="showAddForm()" class="btn small">Add Stock</a>
				</th>
	    	</tr>
		</thead>
		<tbody class="zebra-striped">
			<tr ng-show="addFormIsVisible">                
		        <td><input type="text" ng-model="t" ng-change="getStockData()" style='width: 45px' placeholder="Symbol"></td>
		      	<td ng-model="name">
		        	<input type="hidden" name='{{name}}' style='width: 75px'  placeholder="Description" enabled='false'>
					{{name}}
		      	</td>
				<td>
		        	<input type="text" ng-model="l_cur" style='width: 45px' placeholder="Price">
		      	</td>
		      	<td>
					<a ng-click="saveStock()" class="btn btn-primary">Save</a>        
		        	<a ng-click="hideAddForm()" class="btn">Cancel</a>
		      	</td>
		    </tr>
	    	<tr ng-repeat="stock in stocks | filter:query | orderBy:orderProp">
	        	<td>{{stock.t}}</td>
	        	<td>{{stock.name}}</td>
	        	<td>{{stock.l_cur}}</td>
				<td style='width: 175px;'><button class='btn small danger' ng-click="deleteStock(stock.t,$index)">x</button></td>
	    	</tr>
		</tbody>
	</table>
	</div>                    
</body>
</html>